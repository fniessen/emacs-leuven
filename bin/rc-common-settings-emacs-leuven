# Hey Emacs, this is a -*- sh -*- file ...

if [[ -z "$SSH_CONNECTION" ]]; then
    # Configuration for local mode.

    # Set the default editor to emacsclient.
    export EDITOR="emacsclient"

    # Set an alternate editor to an empty string.
    export ALTERNATE_EDITOR=""

    # Open a file in an Emacs terminal frame using emacsclient.
    et() {
        emacsclient -t -a '' --eval "(find-file \"$1\")"
    }

    # Create an alias 'e' for running emacsclient in non-blocking mode.
    alias e="emacsclient -n"

    # Emacsclient with frame focus and file opening.
    ec() {
        emacsclient -n -r -a '' --eval "(progn
            (select-frame-set-input-focus (selected-frame))
            (find-file \"$1\")
        )"
    }

    # Open Ediff for two files.
    ediff() {
        emacsclient -n -r -a '' --eval "(progn
            (select-frame-set-input-focus (selected-frame))
            (ediff-files \"$1\" \"$2\")
        )"
    }

    # Open VC Dir for a version-controlled directory.
    evcdir() {
        emacsclient -n -r -a '' --eval "(progn
            (select-frame-set-input-focus (selected-frame))
            (vc-dir \"$1\")
        )"
    }

    # Open a new Emacs instance in the background.
    alias bgemacs='emacs &'

    # Alias to open Emacs using the alternate editor setting.
    # If emacsclient can't connect to an existing Emacs server, it will fall
    # back to running a new instance of Emacs.
    alias ealt="emacsclient -n --alternate-editor=emacs"
else
    # Configuration for remote mode.
    for candidate_editor in emacs subl atom nano; do
        if command -v "$candidate_editor" &> /dev/null; then
            # Use the first available editor.
            EDITOR="$candidate_editor"
            break
        fi
    done
    alias e="$EDITOR"                   # Alias 'e' uses the chosen editor.
fi

# Set VISUAL to the same value as EDITOR.
export VISUAL="$EDITOR"

# Cd to the directory of the current buffer in Emacs.
cde() {
    if ! command -v emacsclient > /dev/null 2>&1; then
        printf >&2 "Error: emacsclient command not found.\n"
        printf >&2 "Please install Emacsclient and ensure the binary is in your PATH.\n"
        return 2
    fi

    if ! emacsclient -e '(server-running-p)' > /dev/null 2>&1; then
        printf >&2 "Error: Emacs server is not running.\n"
        printf >&2 "Please start the Emacs server first.\n"
        return 2
    fi

    local dir
    dir="$(emacsclient -e '(with-current-buffer
                               (window-buffer (selected-window))
                             (replace-regexp-in-string "^~" (getenv "HOME")
                                default-directory))' | tr -d '"')"

    if [[ ! -d "$dir" ]]; then
        printf >&2 "Error: directory not found: %s\n" "$dir"
        return 2
    fi

    cd "$dir"
    # The change in working directory will persist after the function has
    # completed.
}
